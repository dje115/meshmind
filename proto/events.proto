syntax = "proto3";
package meshmind.events;
import "common.proto";

enum EventType {
  EVENT_TYPE_UNSPECIFIED = 0;
  CASE_CREATED = 10;
  CASE_CONFIRMED = 11;
  CASE_TAGGED = 12;
  ARTIFACT_PUBLISHED = 20;
  ARTIFACT_DEPRECATED = 21;
  WEB_BRIEF_CREATED = 30;
  WEB_BRIEF_EXPIRED = 31;
  PEER_SEEN = 40;
  PEER_TRUST_UPDATED = 41;
  POLICY_UPDATED = 42;
  TRAIN_JOB_STARTED = 50;
  TRAIN_JOB_COMPLETED = 51;
  MODEL_PROMOTED = 52;
  MODEL_ROLLED_BACK = 53;
  TOOL_INVOCATION_RECORDED = 60;
  DATA_SHARED_RECORDED = 61;

  // Data discovery & ingestion
  DATA_SOURCE_DISCOVERED = 70;
  DATA_SOURCE_CLASSIFIED = 71;
  DATA_SOURCE_APPROVED = 72;
  INGEST_STARTED = 80;
  INGEST_COMPLETED = 81;
  DATASET_MANIFEST_CREATED = 82;

  // Federated learning
  TRAIN_DELTA_PUBLISHED = 90;
  TRAIN_DELTA_APPLIED = 91;
  FEDERATED_ROUND_STARTED = 92;
  FEDERATED_ROUND_COMPLETED = 93;
}

enum ArtifactType {
  ARTIFACT_TYPE_UNSPECIFIED = 0;
  RUNBOOK = 1;
  TEMPLATE = 2;
  RECIPE = 3;
  WEB_BRIEF = 4;
  MODEL_BUNDLE = 5;
  DOCUMENT = 6;
  FACT = 7;
}

message EventEnvelope {
  string event_id = 1;
  EventType type = 2;
  meshmind.common.Timestamp ts = 3;
  meshmind.common.NodeId node_id = 4;
  meshmind.common.TenantId tenant_id = 5;
  meshmind.common.Sensitivity sensitivity = 6;

  meshmind.common.HashRef prev_hash = 7;
  meshmind.common.HashRef event_hash = 8;
  bytes signature = 9;

  repeated meshmind.common.HashRef refs = 10;

  oneof payload {
    CaseCreated case_created = 100;
    CaseConfirmed case_confirmed = 101;
    CaseTagged case_tagged = 102;

    ArtifactPublished artifact_published = 110;
    ArtifactDeprecated artifact_deprecated = 111;

    WebBriefCreated web_brief_created = 120;
    WebBriefExpired web_brief_expired = 121;

    PeerSeen peer_seen = 130;
    PeerTrustUpdated peer_trust_updated = 131;
    PolicyUpdated policy_updated = 132;

    TrainJobStarted train_job_started = 140;
    TrainJobCompleted train_job_completed = 141;
    ModelPromoted model_promoted = 142;
    ModelRolledBack model_rolled_back = 143;

    ToolInvocationRecorded tool_invocation_recorded = 150;
    DataSharedRecorded data_shared_recorded = 151;

    // Data discovery & ingestion payloads
    DataSourceDiscovered data_source_discovered = 160;
    DataSourceClassified data_source_classified = 161;
    DataSourceApproved data_source_approved = 162;
    IngestStarted ingest_started = 170;
    IngestCompleted ingest_completed = 171;
    DatasetManifestCreated dataset_manifest_created = 172;

    // Federated learning payloads
    TrainDeltaPublished train_delta_published = 180;
    TrainDeltaApplied train_delta_applied = 181;
    FederatedRoundStarted federated_round_started = 182;
    FederatedRoundCompleted federated_round_completed = 183;
  }

  repeated string tags = 200;
}

// --- Existing payloads ---

message CaseCreated {
  string case_id = 1;
  string title = 2;
  string summary = 3;
  meshmind.common.HashRef content_ref = 4;
  bool shareable = 5;
}
message CaseConfirmed { string case_id = 1; string outcome = 2; float confidence = 3; }
message CaseTagged { string case_id = 1; repeated string add_tags = 2; repeated string remove_tags = 3; }

message ArtifactPublished {
  string artifact_id = 1;
  ArtifactType artifact_type = 2;
  uint32 version = 3;
  string title = 4;
  meshmind.common.HashRef content_ref = 5;
  bool shareable = 6;
  int64 expires_unix_ms = 7;
}
message ArtifactDeprecated { string artifact_id = 1; uint32 version = 2; string reason = 3; }

message WebSource {
  string url = 1;
  meshmind.common.Timestamp retrieved_at = 2;
  string publisher = 3;
  string snippet = 4;
}
message WebBriefCreated {
  string artifact_id = 1;
  string question = 2;
  string summary = 3;
  repeated WebSource sources = 4;
  float confidence = 5;
  int64 expires_unix_ms = 6;
}
message WebBriefExpired { string artifact_id = 1; uint32 version = 2; }

message PeerSeen { meshmind.common.NodeId peer_node_id = 1; uint32 rtt_ms = 2; repeated string capabilities = 3; }
message PeerTrustUpdated { meshmind.common.NodeId peer_node_id = 1; float trust_score = 2; string reason = 3; }
message PolicyUpdated { string policy_id = 1; uint32 version = 2; meshmind.common.HashRef policy_ref = 3; }

message TrainJobStarted {
  string job_id = 1;
  string target = 2;
  meshmind.common.HashRef dataset_manifest_ref = 3;
  uint32 max_steps = 4;
  uint32 max_minutes = 5;
}
message TrainMetric { string name = 1; double value = 2; }
message TrainJobCompleted {
  string job_id = 1;
  bool success = 2;
  string notes = 3;
  repeated TrainMetric metrics = 4;
  meshmind.common.HashRef model_bundle_ref = 5;
}
message ModelPromoted { string model_id = 1; uint32 version = 2; meshmind.common.HashRef model_bundle_ref = 3; }
message ModelRolledBack { string model_id = 1; uint32 from_version = 2; uint32 to_version = 3; string reason = 4; }

message ToolInvocationRecorded {
  string invocation_id = 1;
  string tool_name = 2;
  string summary = 3;
  bool success = 4;
  uint32 duration_ms = 5;
  meshmind.common.HashRef output_ref = 6;
}

enum ShareChannel { SHARE_CHANNEL_UNSPECIFIED = 0; PEER = 1; WEB = 2; LOCAL_EXPORT = 3; }

message DataSharedRecorded {
  string share_id = 1;
  ShareChannel channel = 2;
  meshmind.common.NodeId peer_node_id = 3;
  string destination = 4;
  string redaction_summary = 5;
  bool allowed = 6;
  string policy_reason = 7;
}

// --- Data discovery & ingestion payloads ---

enum ConnectorType {
  CONNECTOR_TYPE_UNSPECIFIED = 0;
  SQLITE_DB = 1;
  CSV_FOLDER = 2;
  JSON_FOLDER = 3;
  POSTGRES = 4;
  MYSQL = 5;
  ODBC = 6;
  IMAGE_FOLDER = 7;
  DOCUMENT_FOLDER = 8;
}

message DataSourceDiscovered {
  string source_id = 1;
  ConnectorType connector_type = 2;
  string path_or_uri = 3;
  string display_name = 4;
  uint64 estimated_size_bytes = 5;
  uint32 estimated_tables = 6;
  meshmind.common.Timestamp discovered_at = 7;
}

message DataSourceClassified {
  string source_id = 1;
  meshmind.common.HashRef schema_snapshot_ref = 2;
  meshmind.common.Sensitivity suggested_sensitivity = 3;
  bool pii_detected = 4;
  bool secrets_detected = 5;
  uint32 total_columns = 6;
  uint32 restricted_columns = 7;
  string classification_summary = 8;
}

message DataSourceApproved {
  string source_id = 1;
  meshmind.common.HashRef source_profile_ref = 2;
  string approved_by = 3;
  meshmind.common.Timestamp approved_at = 4;
  repeated string allowed_tables = 5;
  uint32 row_limit = 6;
}

message IngestStarted {
  string ingest_id = 1;
  string source_id = 2;
  ConnectorType connector_type = 3;
  meshmind.common.HashRef source_profile_ref = 4;
  meshmind.common.Timestamp started_at = 5;
}

message IngestCompleted {
  string ingest_id = 1;
  string source_id = 2;
  bool success = 3;
  uint64 rows_ingested = 4;
  uint64 documents_created = 5;
  uint64 facts_created = 6;
  uint64 bytes_stored = 7;
  uint32 duration_ms = 8;
  string notes = 9;
}

message DatasetManifestCreated {
  string manifest_id = 1;
  meshmind.common.HashRef manifest_ref = 2;
  string source_id = 3;
  string preset = 4;
  uint64 item_count = 5;
  uint64 total_bytes = 6;
}

// --- Federated learning payloads ---

message TrainDeltaPublished {
  string delta_id = 1;
  string model_id = 2;
  string base_version = 3;
  meshmind.common.HashRef delta_ref = 4;
  repeated TrainMetric metrics = 5;
  meshmind.common.NodeId from_node_id = 6;
}

message TrainDeltaApplied {
  string delta_id = 1;
  string model_id = 2;
  string resulting_version = 3;
  meshmind.common.NodeId applied_by = 4;
  repeated TrainMetric metrics = 5;
}

message FederatedRoundStarted {
  string round_id = 1;
  string model_id = 2;
  uint32 round_number = 3;
  uint32 expected_participants = 4;
  meshmind.common.NodeId coordinator = 5;
  meshmind.common.Timestamp started_at = 6;
}

message FederatedRoundCompleted {
  string round_id = 1;
  string model_id = 2;
  uint32 round_number = 3;
  uint32 actual_participants = 4;
  bool success = 5;
  repeated TrainMetric aggregate_metrics = 6;
  meshmind.common.HashRef resulting_model_ref = 7;
  string notes = 8;
}
